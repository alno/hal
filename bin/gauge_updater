#!/usr/bin/env ruby

$:.unshift('./lib')

require 'gauge'
require 'onewire'

ow = Onewire.client

trap("SIGINT")  { throw :halt }
trap("SIGTERM") { throw :halt }

catch :halt do
  loop do
    sleep(60 - Time.now.sec)

    puts "Updating gauges: #{Time.now}"

    Gauge.each do |g|
      value = ow.read g.source
      g.update value if value
    end
  end
end

puts "Exiting"
