#!/usr/bin/env ruby

$:.unshift('./lib')

require 'gauge'
require 'onewire'

ow = Onewire.client

trap("SIGINT")  { throw :halt }
trap("SIGTERM") { throw :halt }

catch :halt do
  loop do
    sleep(60 - Time.now.sec)

    puts "Updating gauges: #{Time.now}"

    Gauge.each do |g|
      g.update ow.read(g.source)
    end
  end
end

puts "Exiting"
